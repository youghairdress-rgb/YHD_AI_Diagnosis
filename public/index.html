<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>YHD AIパーショナル診断 (Simple Test)</title>
    <link rel="stylesheet" href="css/style.css">

    <!-- ★★★ Firebase SDKとinit.jsをコメントアウト ★★★ -->
    <!--
    <script src="/__/firebase/12.4.0/firebase-app-compat.js"></script>
    <script src="/__/firebase/12.4.0/firebase-storage-compat.js"></script>
    <script src="/__/firebase/12.4.0/firebase-remote-config-compat.js"></script>
    <script src="/__/firebase/init.js"></script>
    -->

</head>
<body>
    <!-- ローディング画面 -->
    <div id="loading-screen" class="loading-container">
        <div class="spinner"></div>
        <p>LIFF SDKを読み込み中...</p>
    </div>

    <!-- 簡単な結果表示用 -->
    <div id="result-message" style="display: none; padding: 20px; text-align: center;"></div>

    <!-- ★★★ LIFF SDK を Body 末尾に + onerror追加 ★★★ -->
    <script
        src="https://static.line-scdn.net/liff/edge/2.23.0/sdk.js"
        charset="utf-8"
        onerror="handleLiffSdkLoadError()">
    </script>

    <!-- ★★★ 最小限の初期化処理 (エラーハンドリング強化) ★★★ -->
    <script>
        let liffSdkLoadFailed = false; // SDK読み込み失敗フラグ

        // ★★★ LIFF SDK読み込みエラーハンドラ ★★★
        function handleLiffSdkLoadError() {
            console.error("!!! LIFF SDK script failed to load (onerror event triggered). Check Network tab for 403 Forbidden error on sdk.js. !!!");
            liffSdkLoadFailed = true;
            // エラーメッセージを表示
            const loadingScreen = document.getElementById('loading-screen');
            const resultMessage = document.getElementById('result-message');
            if (resultMessage) {
                resultMessage.textContent = `LIFF SDK の読み込みに失敗しました (403 Forbidden?)。ネットワーク設定やLINE Developers Consoleの設定を確認してください。`;
                resultMessage.style.color = "red";
                resultMessage.style.display = "block";
            }
            if (loadingScreen) {
                loadingScreen.style.display = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            console.log("DOMContentLoaded: Starting simple LIFF init test...");
            const loadingScreen = document.getElementById('loading-screen');
            const resultMessage = document.getElementById('result-message');
            const liffId = "2008345232-zq4A3Vg3"; // LIFF IDを直接指定

            // onerror が先に発生していたら処理中断
            if (liffSdkLoadFailed) {
                 console.log("DOMContentLoaded: Aborting initialization because LIFF SDK load failed (onerror).");
                 return;
            }

            // 少し待って liff オブジェクトが存在するか確認 (保険的措置)
            await new Promise(resolve => setTimeout(resolve, 100));

            try {
                // この時点でも liff が未定義なら読み込み失敗と判断
                if (typeof liff === 'undefined') {
                    // onerror がトリガーされなかった場合のフォールバック
                    console.error("LIFF SDK object (liff) is still undefined after timeout. Check Network tab for sdk.js loading errors (e.g., 403 Forbidden).");
                     handleLiffSdkLoadError(); // エラー処理を呼び出す
                    return; // 処理中断
                }

                // liff オブジェクトが存在すれば初期化試行
                console.log(`Attempting liff.init() with ID: ${liffId}`);
                 loadingScreen.querySelector('p').textContent = 'LIFFを初期化中...'; // メッセージ変更
                await liff.init({ liffId: liffId });
                console.log("liff.init() succeeded!");

                // --- 成功時の処理 (変更なし) ---
                if(resultMessage) {
                    resultMessage.textContent = "LIFFの初期化に成功しました！";
                    resultMessage.style.color = "green";
                    resultMessage.style.display = "block";
                }
                if (liff.isLoggedIn()) {
                    const profile = await liff.getProfile();
                    console.log("Profile:", profile);
                     if(resultMessage) resultMessage.innerHTML += `<br>こんにちは、${profile.displayName} さん！`;
                } else {
                     if(resultMessage) resultMessage.innerHTML += "<br>LINEにログインしていません。";
                }

            } catch (error) {
                console.error("LIFF Initialization failed:", error);
                if(resultMessage) {
                    resultMessage.textContent = `LIFF初期化エラー: ${error.message}`;
                    resultMessage.style.color = "red";
                    resultMessage.style.display = "block";
                }
            } finally {
                if (loadingScreen && loadingScreen.style.display !== 'none') {
                    loadingScreen.style.display = 'none';
                }
            }
        });
    </script>
</body>
</html>

