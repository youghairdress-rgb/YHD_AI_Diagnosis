<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>YHD AIãƒ‘ãƒ¼ã‚½ãƒŠãƒ«è¨ºæ–­</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="css/style.css">

    <!-- Firebase SDK (Compat) - Provided by Hosting -->
    <script src="/__/firebase/12.4.0/firebase-app-compat.js"></script>
    <script src="/__/firebase/12.4.0/firebase-auth-compat.js"></script>
    <script src="/__/firebase/12.4.0/firebase-storage-compat.js"></script>
    <script src="/__/firebase/12.4.0/firebase-remote-config-compat.js"></script>
    <!-- Firebase Init Script - Provided by Hosting -->
    <!-- This script initializes firebase app instance -->
    <script src="/__/firebase/init.js"></script>

    <!-- LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js" charset="utf-8"></script>
    
    <!-- â˜… ä¿®æ­£: xintegrity -> integrity -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" xintegrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tYHuRgEXEBOBS6qqSL9KxXfGPRCRHpTAfUuiQQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- Global Helper Functions -->
    <script>
        // Define fallback functions in global scope EARLY
        function initializeAppFailureFallback(errorMessage) {
            console.error("[initializeAppFailureFallback] Triggered with:", errorMessage);
            const loadingScreen = document.getElementById('loading-screen');
            if (loadingScreen) loadingScreen.style.display = 'none';
            const bodyElement = document.body || document.createElement('body'); // Ensure body exists
            // Escape the error message before inserting into HTML
            const safeErrorMessage = escapeHtmlFallback(errorMessage);
            bodyElement.innerHTML = `<div style="padding: 20px; text-align: center; color: red; background-color: #fff0f0; border: 1px solid red; border-radius: 8px; max-width: 600px; margin: 20px auto;"><h2>ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼</h2><p>${safeErrorMessage}</p><p>æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚(LIFF SDKã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ã®å ´åˆã€LINE Developers Consoleã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„)</p></div>`;
            if (!document.body) document.documentElement.appendChild(bodyElement);
            bodyElement.style.cssText = `display: flex; justify-content: center; align-items: flex-start; padding-top: 50px; min-height: 100vh;`;
        }

        function escapeHtmlFallback(unsafe) {
             if (typeof unsafe !== 'string') return '';
             return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;").replace(/\//g, "&#x2F;");
        }
    </script>

</head>
<body style="display: flex; justify-content: center; align-items: center; min-height: 100vh;">
    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ -->
    <div id="loading-screen" class="loading-container" style="display: block;">
        <div class="spinner"></div>
        <p>ã‚¢ãƒ—ãƒªã‚’æº–å‚™ã—ã¦ã„ã¾ã™...</p>
    </div>

    <!-- Phase 1: Opening -->
    <div id="phase1" class="phase-container" style="display: none;">
        <div class="card">
            <img src="images/YHDlogo2.gif" alt="YHD AI Diagnosis Logo" class="logo">
            <h1 class="main-title">YHD Ã— AI ã€ä¼¼åˆã‚ã›ã€è¨ºæ–­</h1>
            <p class="description">
                ãŠå®¢æ§˜ã®ã€ä¼¼åˆã†ã€ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«<br>
                AIãŒåˆ†æã—ã€æœ€é©ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ä¼ãˆã¾ã™ï¼
            </p>
            <button id="start-btn" class="btn-primary">è¨ºæ–­ã‚’å§‹ã‚ã‚‹</button>
        </div>
    </div>
    
    <!-- Phase 2: Profile Input -->
    <div id="phase2" class="phase-container" style="display: none;">
        <div class="card">
            <h2 class="form-title">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å…¥åŠ›</h2>
            <div class="form-group">
                <label for="display-name">ãŠåå‰</label>
                <input type="text" id="display-name" class="form-control" readonly>
            </div>
            <div class="form-group">
                <label>æ€§åˆ¥</label>
                <div class="gender-selection">
                    <input type="radio" id="female" name="gender" value="female" checked> <label for="female">å¥³æ€§</label>
                    <input type="radio" id="male" name="gender" value="male"> <label for="male">ç”·æ€§</label>
                    <input type="radio" id="other" name="gender" value="other"> <label for="other">ãã®ä»–</label>
                </div>
            </div>
            <button id="next-to-upload-btn" class="btn-dark">æ’®å½±ã«é€²ã‚€</button>
        </div>
    </div>

     <!-- Phase 3: Upload -->
     <div id="phase3" class="phase-container" style="display: none;">
         <div class="card">
             <h2 class="form-title">å†™çœŸãƒ»å‹•ç”»æ’®å½±</h2>
             <p class="description" style="margin-bottom: 20px;">AIè¨ºæ–­ã®ãŸã‚ã€æŒ‡å®šã•ã‚ŒãŸã‚¢ãƒ³ã‚°ãƒ«ã‹ã‚‰æ’®å½±ã—ã¦ãã ã•ã„ã€‚</p>
             <div class="upload-list">
                 <div id="item-front-photo" class="upload-item">
                     <input type="file" class="file-input" accept="image/jpeg,image/png,image/heic,image/heif" capture="user" hidden>
                     <div class="upload-icon">ğŸ“·</div><div class="upload-text"><strong>å†™çœŸï¼šæ­£é¢</strong><span>é¡”ãŒã¯ã£ãã‚Šã¨</span></div><button class="btn-outline">æ’®å½±</button>
                 </div>
                 <div id="item-side-photo" class="upload-item">
                     <input type="file" class="file-input" accept="image/jpeg,image/png,image/heic,image/heif" capture="environment" hidden>
                     <div class="upload-icon">ğŸ“·</div><div class="upload-text"><strong>å†™çœŸï¼šã‚µã‚¤ãƒ‰</strong><span>æ¨ªé¡”ã¨é«ªã®é•·ã•</span></div><button class="btn-outline">æ’®å½±</button>
                 </div>
                 <div id="item-back-photo" class="upload-item">
                     <input type="file" class="file-input" accept="image/jpeg,image/png,image/heic,image/heif" capture="environment" hidden>
                     <div class="upload-icon">ğŸ“·</div><div class="upload-text"><strong>å†™çœŸï¼šãƒãƒƒã‚¯</strong><span>å¾Œã‚å…¨ä½“ã®é«ªå‹</span></div><button class="btn-outline">æ’®å½±</button>
                 </div>
                 <div id="item-front-video" class="upload-item">
                     <input type="file" class="file-input" accept="video/mp4,video/quicktime,video/mov" capture="user" hidden>
                     <div class="upload-icon">ğŸ¬</div><div class="upload-text"><strong>å‹•ç”»ï¼šæ­£é¢ (3ç§’)</strong><span>å·¦å³ã«é¡”ã‚’å‹•ã‹ã™</span></div><button class="btn-outline">æ’®å½±</button>
                 </div>
                 <div id="item-back-video" class="upload-item">
                     <input type="file" class="file-input" accept="video/mp4,video/quicktime,video/mov" capture="environment" hidden>
                     <div class="upload-icon">ğŸ¬</div><div class="upload-text"><strong>å‹•ç”»ï¼šãƒãƒƒã‚¯ (3ç§’)</strong><span>é«ªå…¨ä½“ã®å‹•ã</span></div><button class="btn-outline">æ’®å½±</button>
                 </div>
             </div>
             <button id="request-diagnosis-btn" class="btn-dark btn-disabled" disabled>AIè¨ºæ–­ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</button>
         </div>
     </div>
     
     <!-- Phase 3.5: Loading -->
     <div id="phase3.5" class="phase-container" style="display: none;">
         <div class="card">
             <div class="spinner"></div>
             <h2 class="form-title" style="margin-top: 25px; margin-bottom: 10px;">AIãŒè¨ºæ–­ä¸­ã§ã™</h2>
             <p class="description" id="diagnosis-status-text">ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„...</p>
         </div>
     </div>
     
     <!-- Phase 4: Diagnosis Result -->
    <div id="phase4" class="phase-container" style="display: none;">
         <div class="card">
             <h2 class="form-title">AIè¨ºæ–­çµæœ</h2>
             
             <div class="result-section">
                 <h3 class="result-title"><img src="images/é¡”è¨ºæ–­.png" alt="" class="result-icon"> ãŠé¡”ã®ç‰¹å¾´</h3>
                 <div id="face-results" class="result-grid"></div> <!-- ID: face-results -->
             </div>
             <div class="result-section">
                 <h3 class="result-title"><img src="images/éª¨æ ¼è¨ºæ–­.png" alt="" class="result-icon"> éª¨æ ¼ãƒ»ãƒœãƒ‡ã‚£</h3>
                 <div id="skeleton-results" class="result-grid"></div> <!-- ID: skeleton-results -->
             </div>
             <div class="result-section">
                 <h3 class="result-title"><img src="images/ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ã‚«ãƒ©ãƒ¼.png" alt="" class="result-icon"> ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ã‚«ãƒ©ãƒ¼</h3>
                 <div id="personal-color-results" class="result-grid"></div> <!-- ID: personal-color-results -->
             </div>
             
             <button id="next-to-proposal-btn" class="btn-dark">AIææ¡ˆã‚’è¦‹ã‚‹</button>
             <button id="save-phase4-btn" class="btn-secondary no-print">è¨ºæ–­çµæœã‚’ç”»åƒã§ä¿å­˜</button>
         </div>
    </div>
     
     <!-- Phase 5: Proposal -->
    <div id="phase5" class="phase-container" style="display: none;">
         <div class="card">
             <h2 class="form-title">AIãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ææ¡ˆ</h2>
             
             <div class="proposal-section">
                 <h3 class="proposal-title"><img src="images/ãƒ˜ã‚¢ã‚¹ã‚¿ã‚¤ãƒ«.png" alt="" class="proposal-icon"> ä¼¼åˆã†ãƒ˜ã‚¢ã‚¹ã‚¿ã‚¤ãƒ«</h3>
                 <div id="hairstyle-proposal" class="proposal-grid"></div> <!-- ID: hairstyle-proposal -->
             </div>
             <div class="proposal-section">
                 <h3 class="proposal-title"><img src="images/ãƒ˜ã‚¢ã‚«ãƒ©ãƒ¼.png" alt="" class="proposal-icon"> ä¼¼åˆã†ãƒ˜ã‚¢ã‚«ãƒ©ãƒ¼</h3>
                 <div id="haircolor-proposal" class="proposal-grid"></div> <!-- ID: haircolor-proposal -->
             </div>

             <div class="proposal-section">
                 <h3 class="proposal-title"><img src="images/ã‚«ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³.png" alt="" class="proposal-icon"> ç›¸æ€§ãƒ™ã‚¹ãƒˆã‚«ãƒ©ãƒ¼</h3>
                 <div id="best-colors-proposal" class="best-colors-grid">
                     <!-- JSã§ã“ã“ã«è‰²è¦‹æœ¬ãŒæŒ¿å…¥ã•ã‚Œã‚‹ -->
                 </div>
             </div>

             <div class="proposal-section">
                 <h3 class="proposal-title"><img src="images/ãƒ¡ã‚¤ã‚¯.png" alt="" class="proposal-icon"> ä¼¼åˆã†ãƒ¡ã‚¤ã‚¯</h3>
                 <div id="makeup-proposal" class="makeup-grid">
                     <!-- JSã§ã“ã“ã«ãƒ¡ã‚¤ã‚¯æƒ…å ±ãŒæŒ¿å…¥ã•ã‚Œã‚‹ -->
                 </div>
             </div>
             
             <div class="proposal-section">
                 <h3 class="proposal-title"><img src="images/AIç¾å®¹å¸«.png" alt="" class="proposal-icon"> AIã‹ã‚‰ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹</h3>
                 <div class="top-stylist-comment">
                     <p id="top-stylist-comment-text"></p> <!-- ID: top-stylist-comment-text -->
                 </div>
             </div>
             
             <button id="next-to-generate-btn" class="btn-dark btn-disabled" disabled>åˆæˆç”»åƒã‚’ä½œæˆ</button>
             <button id="save-phase5-btn" class="btn-secondary no-print">ææ¡ˆå†…å®¹ã‚’ç”»åƒã§ä¿å­˜</button>
             <button id="back-to-diagnosis-btn" class="btn-secondary btn-secondary-white no-print">è¨ºæ–­çµæœã«æˆ»ã‚‹</button>
         </div>
    </div>
    
    <!-- Phase 6: Generated Image -->
    <div id="phase6" class="phase-container" style="display: none;">
         <div class="card">
             <h2 class="form-title">ãƒ˜ã‚¢ã‚¹ã‚¿ã‚¤ãƒ«åˆæˆçµæœ</h2>
             
             <!-- ã‚¹ãƒ”ãƒŠãƒ¼ã‚’ç”»åƒã¨é‡ã­ã‚‹ãŸã‚ã®ã‚³ãƒ³ãƒ†ãƒŠ -->
             <div class="generated-image-container">
                 <img id="generated-image" src="https://placehold.co/300x300/e2e8f0/cbd5e1?text=Awaiting..." alt="åˆæˆã•ã‚ŒãŸãƒ˜ã‚¢ã‚¹ã‚¿ã‚¤ãƒ«">
                 <!-- å¾®èª¿æ•´ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”¨ã‚¹ãƒ”ãƒŠãƒ¼ -->
                 <div id="refinement-spinner" class="spinner" style="display: none;"></div>
             </div>
             
             <p class="description">AIãŒç”Ÿæˆã—ãŸåˆæˆç”»åƒã§ã™ã€‚</p>

             <!-- å¾®èª¿æ•´UI -->
             <div class="refinement-section">
                 <h3 class="refinement-title"><img src="images/AIç¾å®¹å¸«.png" alt="" class="proposal-icon"> ç”»åƒã®å¾®èª¿æ•´</h3>
                <p class="description" style="margin-bottom: 15px; font-size: 14px; text-align: left;">ã€Œã‚‚ã†å°‘ã—æ˜ã‚‹ãã€ã€Œå‰é«ªã‚’çŸ­ãã€ãªã©ã€è¦æœ›ã‚’ä¼ãˆã¦ç”»åƒã‚’èª¿æ•´ã§ãã¾ã™ã€‚</p>
                <div class="form-group" style="margin-bottom: 15px;">
                    <input type="text" id="refinement-prompt-input" class="form-control" placeholder="ä¾‹ï¼šã‚‚ã†å°‘ã—é«ªã‚’æ˜ã‚‹ãã—ã¦">
                </div>
                <button id="refine-image-btn" class="btn-dark">å¤‰æ›´ã‚’åæ˜ ã™ã‚‹</button>
             </div>
             
             <!-- â˜…â˜…â˜… ä¿®æ­£: 2ã¤ã®ãƒœã‚¿ãƒ³ã«åˆ†é›¢ â˜…â˜…â˜… -->
             <!-- 1. ãŠæ°—ã«å…¥ã‚Šä¿å­˜ãƒœã‚¿ãƒ³ (DBä¿å­˜) -->
             <button id="save-generated-image-to-db-btn" class="btn-primary no-print">ã“ã®åˆæˆç”»åƒã‚’ä¿å­˜ã™ã‚‹</button>
             <!-- 2. ç”»é¢å…±æœ‰ãƒœã‚¿ãƒ³ (html2canvas) -->
             <button id="share-phase6-btn" class="btn-secondary no-print">çµæœã‚’ä¿å­˜ã—ã¦LINEã§å…±æœ‰</button>
             
             <!-- â˜… ä¿®æ­£: æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å‰Šé™¤ -->
             <button id="back-to-proposal-btn" class="btn-outline">ææ¡ˆã«æˆ»ã‚‹</button>
         </div>
    </div>

    <!-- App Scripts (Load at the end, NO type="module") -->
    <script src="js/ui.js"></script>
    <script src="js/main.js"></script> <!-- public/js/main.js (ç¾åœ¨ã‚¨ãƒ‡ã‚£ã‚¿ã«ã‚ã‚‹ã‚‚ã®) -->

    <!-- Initialization Trigger -->
    <script>
        function checkFirebaseAndInit() {
            // Check if firebase app instance is initialized by /__/firebase/init.js
            // Also check if other necessary components are ready globally
            if (typeof firebase !== 'undefined' && typeof firebase.app === 'function' && firebase.app() && // Check if firebase app is initialized
                typeof liff !== 'undefined' &&
                typeof main === 'function' &&
                typeof changePhase === 'function')
            {
                console.log("Firebase App and other components ready. Setting up Auth listener...");
                // Now it's safer to access firebase.auth()
                firebase.auth().onAuthStateChanged(user => {
                    if (user) {
                        console.log("Firebase Auth ready with user:", user.uid);
                        // Only call main once after auth is ready
                        if (!window.mainCalled) {
                            window.mainCalled = true;
                            console.log("Calling main()...");
                            main(); // Call the main function from main.js
                        }
                    } else {
                        // User is signed out. Attempt anonymous sign-in if not already trying.
                        if (!window.signingInAnonymously) {
                             window.signingInAnonymously = true;
                             console.log("No Firebase user, attempting anonymous sign-in...");
                             firebase.auth().signInAnonymously().catch((error) => {
                                 console.error("Anonymous sign-in failed:", error);
                                 // Use the global error display function
                                 initializeAppFailureFallback("FirebaseåŒ¿åèªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
                             }).finally(() => {
                                window.signingInAnonymously = false;
                             });
                        }
                    }
                });
            } else {
                console.warn("Firebase App or other components not ready yet, will retry...");
                 // Critical errors (should not happen if Hosting is configured correctly)
                 if (document.readyState === 'complete' && typeof firebase === 'undefined') {
                     initializeAppFailureFallback("Firebase SDK ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚Hostingè¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                     return; // Stop retrying
                 }
                  if (document.readyState === 'complete' && typeof liff === 'undefined') {
                     initializeAppFailureFallback("LIFF SDK ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã¾ãŸã¯LIFFè¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                     return; // Stop retrying
                 }
                setTimeout(checkFirebaseAndInit, 150); // Retry
            }
        }

        // Start checking after the DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
             console.log("DOMContentLoaded fired. Starting initialization check...");
             window.mainCalled = false; // Flag to ensure main() is called only once
             window.signingInAnonymously = false; // Flag for anonymous sign-in attempt
             checkFirebaseAndInit(); // Start the check loop
        });
    </script>
</body>
</html>