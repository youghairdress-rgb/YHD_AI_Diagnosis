<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>YHD AIパーショナル診断</title>
    <link rel="stylesheet" href="css/style.css">

    <!-- SDKスクリプト -->
    <script src="https://static.line-scdn.net/liff/edge/2.23.0/sdk.js"></script>
    <script src="/__/firebase/12.4.0/firebase-app-compat.js"></script>
    <script src="/__/firebase/12.4.0/firebase-storage-compat.js"></script>
    <script src="/__/firebase/12.4.0/firebase-remote-config-compat.js"></script>
    <!-- Firebase Init -->
    <script src="/__/firebase/init.js"></script>

</head>
<body>
    <!-- ローディング画面 -->
    <div id="loading-screen" class="loading-container">
        <div class="spinner"></div>
        <p>アプリを準備しています...</p>
    </div>

    <!-- 各フェーズのコンテナ (変更なし) -->
    <div id="phase1" class="phase-container">
        <div class="card">
            <img src="images/YHDlogo2.gif" alt="YHD AI Diagnosis Logo" class="logo">
            <h1 class="main-title">YHD × AI 『似合わせ』診断</h1>
            <p class="description">
                お客様の『似合う』を実現するために<br>
                AIが分析し、最適なアドバイスを伝えます！
            </p>
            <button id="start-btn" class="btn-primary">診断を始める</button>
        </div>
    </div>
    <div id="phase2" class="phase-container">
        <div class="card">
            <h2 class="form-title">プロフィール入力</h2>
            <div class="form-group">
                <label for="display-name">お名前</label>
                <input type="text" id="display-name" class="form-control" readonly>
            </div>
            <div class="form-group">
                <label>性別</label>
                <div class="gender-selection">
                    <input type="radio" id="female" name="gender" value="female" checked>
                    <label for="female">女性</label>
                    <input type="radio" id="male" name="gender" value="male">
                    <label for="male">男性</label>
                    <input type="radio" id="other" name="gender" value="other">
                    <label for="other">その他</label>
                </div>
            </div>
            <button id="next-to-upload-btn" class="btn-dark">撮影に進む</button>
        </div>
    </div>
    <div id="phase3" class="phase-container">
        <div class="card">
            <h2 class="form-title">写真・動画撮影</h2>
            <p class="description" style="margin-bottom: 20px;">AI診断のため、指定されたアングルから撮影してください。</p>
            <div class="upload-list">
                <div id="item-front-photo" class="upload-item"><input type="file" class="file-input" accept="image/*" hidden><div class="upload-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M4 4h3l2-2h6l2 2h3v18H4V4zm8 14c3.31 0 6-2.69 6-6s-2.69-6-6-6-6 2.69-6 6 2.69 6 6 6z"/><circle cx="12" cy="12" r="4"/></svg></div><div class="upload-text"><strong>写真：正面</strong><span>顔がはっきりと写るように</span></div><button class="btn-outline">撮影する</button></div>
                <div id="item-side-photo" class="upload-item"><input type="file" class="file-input" accept="image/*" hidden><div class="upload-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M4 4h3l2-2h6l2 2h3v18H4V4zm8 14c3.31 0 6-2.69 6-6s-2.69-6-6-6-6 2.69-6 6 2.69 6 6 6z"/><circle cx="12" cy="12" r="4"/></svg></div><div class="upload-text"><strong>写真：サイド</strong><span>横顔と髪の長さがわかるように</span></div><button class="btn-outline">撮影する</button></div>
                <div id="item-back-photo" class="upload-item"><input type="file" class="file-input" accept="image/*" hidden><div class="upload-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M4 4h3l2-2h6l2 2h3v18H4V4zm8 14c3.31 0 6-2.69 6-6s-2.69-6-6-6-6 2.69-6 6 2.69 6 6 6z"/><circle cx="12" cy="12" r="4"/></svg></div><div class="upload-text"><strong>写真：バック</strong><span>後ろ全体の髪型がわかるように</span></div><button class="btn-outline">撮影する</button></div>
                <div id="item-front-video" class="upload-item"><input type="file" class="file-input" accept="video/*" hidden><div class="upload-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg></div><div class="upload-text"><strong>動画：正面 (3秒)</strong><span>ゆっくりと左右に顔を動かす</span></div><button class="btn-outline">撮影する</button></div>
                <div id="item-back-video" class="upload-item"><input type="file" class="file-input" accept="video/*" hidden><div class="upload-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg></div><div class="upload-text"><strong>動画：バック (3秒)</strong><span>髪全体の動きがわかるように</span></div><button class="btn-outline">撮影する</button></div>
            </div>
            <button id="request-diagnosis-btn" class="btn-dark btn-disabled" disabled>AI診断をリクエストする</button>
        </div>
    </div>
    <div id="phase3.5" class="phase-container"><div class="card"><div class="spinner"></div><h2 class="form-title" style="margin-top: 25px; margin-bottom: 10px;">AIが診断中です</h2><p class="description">診断リクエストを送信中...</p></div></div>
    <div id="phase4" class="phase-container"><div class="card"><h2 class="form-title">AI診断結果</h2><div class="result-section"><h3 class="result-title"><span class="result-icon">😊</span> 顔診断</h3><div id="face-results" class="result-grid"></div></div><div class="result-section"><h3 class="result-title"><span class="result-icon">🧍</span> 骨格診断</h3><div id="skeleton-results" class="result-grid"></div></div><div class="result-section"><h3 class="result-title"><span class="result-icon">🎨</span> パーソナルカラー診断</h3><div id="personal-color-results" class="result-grid"></div></div><button id="next-to-proposal-btn" class="btn-dark">AIからの提案を見る</button></div></div>
    <div id="phase5" class="phase-container"><div class="card"><h2 class="form-title">AIパーソナル提案</h2><div class="proposal-section"><h3 class="proposal-title"><span class="proposal-icon">✂️</span> ヘアスタイル提案</h3><div id="hairstyle-proposal" class="proposal-grid"></div></div><div class="proposal-section"><h3 class="proposal-title"><span class="proposal-icon">🎨</span> ヘアカラー提案</h3><div id="haircolor-proposal" class="proposal-grid"></div></div><div class="proposal-section"><h3 class="proposal-title"><span class="proposal-icon">✨</span> トップスタイリストAIより</h3><div class="top-stylist-comment"><p id="top-stylist-comment-text"></p></div></div><button id="next-to-generate-btn" class="btn-dark btn-disabled" disabled>合成画像を作成する</button></div></div>
    <div id="phase6" class="phase-container"></div>

    <!-- UIロジックとメインのJavaScript (先に読み込む) -->
    <script src="js/ui.js"></script>
    <script src="js/main.js"></script>

    <!-- 初期化処理 -->
    <script>
      // ★★★ AppState をここで定義 ★★★
      const AppState = {
        firebase: null, // Firebase services (storage, remoteConfig)
        liffId: '',     // LIFF ID from Remote Config
        userProfile: { displayName: "ゲスト", userId: `guest_${Date.now()}` }, // Default guest profile
        gender: 'female', // Default gender
        uploadedFiles: {}, // key: item-id, value: File object
        uploadedFileUrls: {}, // key: item-id, value: Firebase Storage URL
        selectedProposal: { // User's selection in Phase 5
            hairstyle: null,
            haircolor: null
        },
        aiDiagnosisResult: null, // Result from Phase 4
        aiProposal: null,        // Proposal from Phase 5
        generatedImageUrl: null  // Result image URL from Phase 6
      };

      // エラー表示用の関数 (変更なし)
      function initializeAppFailure(errorMessage) {
            const loadingScreen = document.getElementById('loading-screen');
            if (loadingScreen) loadingScreen.style.display = 'none';
            const bodyElement = document.body;
            if (!document.querySelector('.error-message')) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.style.padding = '20px';
                errorDiv.style.textAlign = 'center';
                errorDiv.style.color = 'red';
                errorDiv.innerHTML = `<h2>アプリケーションエラー</h2><p>${escapeHtml(errorMessage)}</p><p>時間をおいて再度お試しください。</p>`;
                bodyElement.innerHTML = '';
                bodyElement.appendChild(errorDiv);
                bodyElement.style.display = 'flex';
                bodyElement.style.justifyContent = 'center';
                bodyElement.style.alignItems = 'center';
                bodyElement.style.minHeight = '100vh';
            } else {
                 const errorP = document.querySelector('.error-message p:first-of-type');
                 if(errorP) errorP.innerHTML = escapeHtml(errorMessage);
            }
      }
      function escapeHtml(unsafe) {
          if (typeof unsafe !== 'string') return '';
          return unsafe
               .replace(/&/g, "&amp;")
               .replace(/</g, "&lt;")
               .replace(/>/g, "&gt;")
               .replace(/"/g, "&quot;")
               .replace(/'/g, "&#039;");
      }

      // Firebase 初期化完了イベントを待ってから main を呼び出す
      document.addEventListener('DOMContentLoaded', () => {
          console.log("DOMContentLoaded event fired.");
          document.addEventListener('firebase-initialized', () => {
              console.log("firebase-initialized event received.");
              try {
                  if (typeof firebase === 'undefined') {
                      throw new Error("Firebase object is still undefined after firebase-initialized event.");
                  }

                  // Firebaseサービスを AppState に格納 (window.firebaseGlobal は不要に)
                  const storage = firebase.storage();
                  const remoteConfig = firebase.remoteConfig();
                  console.log("Firebase storage and remoteConfig objects obtained.");

                  remoteConfig.settings = {
                      minimumFetchIntervalMillis: 3600000,
                      fetchTimeoutMillis: 10000
                  };
                  remoteConfig.defaultConfig = {
                      'liff_id': '2008345232-zq4A3Vg3' // フォールバック
                  };
                  console.log("Remote Config settings applied.");

                  // ★★★ AppState.firebase にサービスを格納 ★★★
                  AppState.firebase = { storage, remoteConfig };
                  console.log("Firebase services assigned to AppState.firebase.");

                  // main.js の main 関数を実行
                  if (typeof main === 'function') {
                      console.log("Calling main function...");
                      main(); // AppState はこの時点で定義されている
                  } else {
                      throw new Error("main function not found in main.js.");
                  }

              } catch (error) {
                  console.error("Error during Firebase setup or main() call:", error);
                  initializeAppFailure("アプリケーションの初期化中にエラーが発生しました: " + error.message);
              }
          });

          // init.js が既に完了していた場合のフォールバック
          if (typeof firebase !== 'undefined' && !AppState.firebase) { // AppState.firebase でチェック
              console.log("Firebase object already defined on DOMContentLoaded, simulating firebase-initialized.");
              const event = new Event('firebase-initialized');
              document.dispatchEvent(event);
          } else if (typeof firebase === 'undefined') {
              console.log("Firebase object not defined yet, waiting for firebase-initialized event...");
          }

      });
    </script>
</body>
</html>

