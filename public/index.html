<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>YHD AIãƒ‘ãƒ¼ã‚·ãƒ§ãƒŠãƒ«è¨ºæ–­</title>
    <link rel="stylesheet" href="css/style.css">

    <!-- Firebase SDK (Headå†…ã§èª­ã¿è¾¼ã‚€) -->
    <script src="/__/firebase/12.4.0/firebase-app-compat.js"></script>
    <script src="/__/firebase/12.4.0/firebase-storage-compat.js"></script>
    <script src="/__/firebase/12.4.0/firebase-remote-config-compat.js"></script>
    <!-- Firebase Init Script (Headå†…ã§èª­ã¿è¾¼ã‚€) -->
    <script src="/__/firebase/init.js"></script>

    <!-- â˜…â˜…â˜… LIFF SDK ã‚’ Head å†…ã§èª­ã¿è¾¼ã‚€ â˜…â˜…â˜… -->
    <script src="https://static.line-scdn.net/liff/edge/2.23.0/sdk.js" charset="utf-8"></script>

</head>
<body>
    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ -->
    <div id="loading-screen" class="loading-container">
        <div class="spinner"></div>
        <p>ã‚¢ãƒ—ãƒªã‚’æº–å‚™ã—ã¦ã„ã¾ã™...</p>
    </div>

    <!-- å„ãƒ•ã‚§ãƒ¼ã‚ºã®ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div id="phase1" class="phase-container">
        <div class="card">
            <img src="images/YHDlogo2.gif" alt="YHD AI Diagnosis Logo" class="logo">
            <h1 class="main-title">YHD Ã— AI ã€ä¼¼åˆã‚ã›ã€è¨ºæ–­</h1>
            <p class="description">
                ãŠå®¢æ§˜ã®ã€ä¼¼åˆã†ã€ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«<br>
                AIãŒåˆ†æã—ã€æœ€é©ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ä¼ãˆã¾ã™ï¼
            </p>
            <button id="start-btn" class="btn-primary">è¨ºæ–­ã‚’å§‹ã‚ã‚‹</button>
        </div>
    </div>
    <div id="phase2" class="phase-container">
        <div class="card">
            <h2 class="form-title">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å…¥åŠ›</h2>
            <div class="form-group">
                <label for="display-name">ãŠåå‰</label>
                <input type="text" id="display-name" class="form-control" readonly>
            </div>
            <div class="form-group">
                <label>æ€§åˆ¥</label>
                <div class="gender-selection">
                    <input type="radio" id="female" name="gender" value="female" checked>
                    <label for="female">å¥³æ€§</label>
                    <input type="radio" id="male" name="gender" value="male">
                    <label for="male">ç”·æ€§</label>
                    <input type="radio" id="other" name="gender" value="other">
                    <label for="other">ãã®ä»–</label>
                </div>
            </div>
            <button id="next-to-upload-btn" class="btn-dark">æ’®å½±ã«é€²ã‚€</button>
        </div>
    </div>
    <div id="phase3" class="phase-container">
        <div class="card">
            <h2 class="form-title">å†™çœŸãƒ»å‹•ç”»æ’®å½±</h2>
            <p class="description" style="margin-bottom: 20px;">AIè¨ºæ–­ã®ãŸã‚ã€æŒ‡å®šã•ã‚ŒãŸã‚¢ãƒ³ã‚°ãƒ«ã‹ã‚‰æ’®å½±ã—ã¦ãã ã•ã„ã€‚</p>
            <div class="upload-list">
                <div id="item-front-photo" class="upload-item"><input type="file" class="file-input" accept="image/*" hidden><div class="upload-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M4 4h3l2-2h6l2 2h3v18H4V4zm8 14c3.31 0 6-2.69 6-6s-2.69-6-6-6-6 2.69-6 6 2.69 6 6 6z"/><circle cx="12" cy="12" r="4"/></svg></div><div class="upload-text"><strong>å†™çœŸï¼šæ­£é¢</strong><span>é¡”ãŒã¯ã£ãã‚Šã¨å†™ã‚‹ã‚ˆã†ã«</span></div><button class="btn-outline">æ’®å½±ã™ã‚‹</button></div>
                <div id="item-side-photo" class="upload-item"><input type="file" class="file-input" accept="image/*" hidden><div class="upload-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M4 4h3l2-2h6l2 2h3v18H4V4zm8 14c3.31 0 6-2.69 6-6s-2.69-6-6-6-6 2.69-6 6 2.69 6 6 6z"/><circle cx="12" cy="12" r="4"/></svg></div><div class="upload-text"><strong>å†™çœŸï¼šã‚µã‚¤ãƒ‰</strong><span>æ¨ªé¡”ã¨é«ªã®é•·ã•ãŒã‚ã‹ã‚‹ã‚ˆã†ã«</span></div><button class="btn-outline">æ’®å½±ã™ã‚‹</button></div>
                <div id="item-back-photo" class="upload-item"><input type="file" class="file-input" accept="image/*" hidden><div class="upload-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M4 4h3l2-2h6l2 2h3v18H4V4zm8 14c3.31 0 6-2.69 6-6s-2.69-6-6-6-6 2.69-6 6 2.69 6 6 6z"/><circle cx="12" cy="12" r="4"/></svg></div><div class="upload-text"><strong>å†™çœŸï¼šãƒãƒƒã‚¯</strong><span>å¾Œã‚å…¨ä½“ã®é«ªå‹ãŒã‚ã‹ã‚‹ã‚ˆã†ã«</span></div><button class="btn-outline">æ’®å½±ã™ã‚‹</button></div>
                <div id="item-front-video" class="upload-item"><input type="file" class="file-input" accept="video/*" hidden><div class="upload-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg></div><div class="upload-text"><strong>å‹•ç”»ï¼šæ­£é¢ (3ç§’)</strong><span>ã‚†ã£ãã‚Šã¨å·¦å³ã«é¡”ã‚’å‹•ã‹ã™</span></div><button class="btn-outline">æ’®å½±ã™ã‚‹</button></div>
                <div id="item-back-video" class="upload-item"><input type="file" class="file-input" accept="video/*" hidden><div class="upload-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg></div><div class="upload-text"><strong>å‹•ç”»ï¼šãƒãƒƒã‚¯ (3ç§’)</strong><span>é«ªå…¨ä½“ã®å‹•ããŒã‚ã‹ã‚‹ã‚ˆã†ã«</span></div><button class="btn-outline">æ’®å½±ã™ã‚‹</button></div>
            </div>
            <button id="request-diagnosis-btn" class="btn-dark btn-disabled" disabled>AIè¨ºæ–­ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹</button>
        </div>
    </div>
    <div id="phase3.5" class="phase-container"><div class="card"><div class="spinner"></div><h2 class="form-title" style="margin-top: 25px; margin-bottom: 10px;">AIãŒè¨ºæ–­ä¸­ã§ã™</h2><p class="description">è¨ºæ–­ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ä¸­...</p></div></div>
    <div id="phase4" class="phase-container"><div class="card"><h2 class="form-title">AIè¨ºæ–­çµæœ</h2><div class="result-section"><h3 class="result-title"><span class="result-icon">ğŸ˜Š</span> é¡”è¨ºæ–­</h3><div id="face-results" class="result-grid"></div></div><div class="result-section"><h3 class="result-title"><span class="result-icon">ğŸ§</span> éª¨æ ¼è¨ºæ–­</h3><div id="skeleton-results" class="result-grid"></div></div><div class="result-section"><h3 class="result-title"><span class="result-icon">ğŸ¨</span> ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ã‚«ãƒ©ãƒ¼è¨ºæ–­</h3><div id="personal-color-results" class="result-grid"></div></div><button id="next-to-proposal-btn" class="btn-dark">AIã‹ã‚‰ã®ææ¡ˆã‚’è¦‹ã‚‹</button></div></div>
    <div id="phase5" class="phase-container"><div class="card"><h2 class="form-title">AIãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ææ¡ˆ</h2><div class="proposal-section"><h3 class="proposal-title"><span class="proposal-icon">âœ‚ï¸</span> ãƒ˜ã‚¢ã‚¹ã‚¿ã‚¤ãƒ«ææ¡ˆ</h3><div id="hairstyle-proposal" class="proposal-grid"></div></div><div class="proposal-section"><h3 class="proposal-title"><span class="proposal-icon">ğŸ¨</span> ãƒ˜ã‚¢ã‚«ãƒ©ãƒ¼ææ¡ˆ</h3><div id="haircolor-proposal" class="proposal-grid"></div></div><div class="proposal-section"><h3 class="proposal-title"><span class="proposal-icon">âœ¨</span> ãƒˆãƒƒãƒ—ã‚¹ã‚¿ã‚¤ãƒªã‚¹ãƒˆAIã‚ˆã‚Š</h3><div class="top-stylist-comment"><p id="top-stylist-comment-text"></p></div></div><button id="next-to-generate-btn" class="btn-dark btn-disabled" disabled>åˆæˆç”»åƒã‚’ä½œæˆã™ã‚‹</button></div></div>
    <div id="phase6" class="phase-container"></div>

    <!-- UIãƒ­ã‚¸ãƒƒã‚¯ã¨ãƒ¡ã‚¤ãƒ³ã®JavaScript (Body æœ«å°¾) -->
    <script src="js/ui.js"></script>
    <script src="js/main.js"></script>

    <!-- åˆæœŸåŒ–å‡¦ç† -->
    <script>
        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºç”¨ã®ã‚·ãƒ³ãƒ—ãƒ«ãªé–¢æ•° (main.js ãŒèª­ã¿è¾¼ã‚ãªã‹ã£ãŸå ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯)
        function initializeAppFailureFallback(errorMessage) {
            const loadingScreen = document.getElementById('loading-screen');
            if (loadingScreen) loadingScreen.style.display = 'none';
            const bodyElement = document.body;
            bodyElement.innerHTML = `<div style="padding: 20px; text-align: center; color: red;"><h2>ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼</h2><p>${errorMessage}</p><p>æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚</p></div>`;
            bodyElement.style.display = 'flex';
            bodyElement.style.justifyContent = 'center';
            bodyElement.style.alignItems = 'center';
            bodyElement.style.minHeight = '100vh';
        }

        // Firebase åˆæœŸåŒ–å®Œäº†ã‚¤ãƒ™ãƒ³ãƒˆã‚’å¾…ã£ã¦ã‹ã‚‰ main ã‚’å‘¼ã³å‡ºã™
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOMContentLoaded event fired.");
            document.addEventListener('firebase-initialized', () => {
                console.log("firebase-initialized event received.");
                try {
                    if (typeof firebase === 'undefined' || typeof firebase.storage === 'undefined' || typeof firebase.remoteConfig === 'undefined') {
                        throw new Error("Firebase object or services are still undefined after firebase-initialized event.");
                    }

                    // Firebaseã‚µãƒ¼ãƒ“ã‚¹ã‚’å–å¾—
                    const storage = firebase.storage();
                    const remoteConfig = firebase.remoteConfig();
                    console.log("Firebase storage and remoteConfig objects obtained.");

                    // Remote Configã®åˆæœŸè¨­å®š
                    remoteConfig.settings = {
                        minimumFetchIntervalMillis: 3600000, // 1 hour
                        fetchTimeoutMillis: 10000 // 10 seconds
                    };
                    remoteConfig.defaultConfig = {
                        'liff_id': '2008345232-zq4A3Vg3' // â˜…â˜…â˜… æ–°ã—ã„ LIFF ID (ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯) â˜…â˜…â˜…
                    };
                    console.log("Remote Config settings applied.");

                    // main.js ã® main é–¢æ•°ã‚’å®Ÿè¡Œã—ã€Firebaseã‚µãƒ¼ãƒ“ã‚¹ã‚’æ¸¡ã™
                    if (typeof main === 'function') {
                        console.log("Calling main function...");
                        main({ storage, remoteConfig }); // â˜…â˜…â˜… å¼•æ•°ã¨ã—ã¦æ¸¡ã™ â˜…â˜…â˜…
                    } else {
                        throw new Error("main function not found in main.js. Check script loading order.");
                    }

                } catch (error) {
                    console.error("Error during Firebase setup or main() call:", error);
                    // main.js ã® initializeAppFailure ãŒä½¿ãˆã‚‹ã‹è©¦ã™
                    if (typeof initializeAppFailure === 'function') {
                         initializeAppFailure("ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + error.message);
                    } else {
                         initializeAppFailureFallback("ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + error.message);
                    }
                }
            });

            // init.js ãŒ DOMContentLoaded ã‚ˆã‚Šå…ˆã«å®Œäº†ã—ã¦ã„ãŸå ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            if (typeof firebase !== 'undefined' && typeof firebase.storage !== 'undefined' && typeof firebase.remoteConfig !== 'undefined') {
                 // æ—¢ã« main ãŒå‘¼ã°ã‚Œã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèªã™ã‚‹ (ã‚ˆã‚Šå®‰å…¨ã«)
                 // AppState ãŒ main.js ã§å®šç¾©ã•ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§ã¯ AppState.firebase ã‚’ãƒã‚§ãƒƒã‚¯ã§ããªã„
                 // ä»£ã‚ã‚Šã«å˜ç´”ãªãƒ•ãƒ©ã‚°ã‚’ä½¿ã†ã‹ã€ã‚¤ãƒ™ãƒ³ãƒˆã®å†ç™ºç«ã§å¯¾å¿œ
                 if (!window.mainFunctionCalled) { // main.jså´ã§ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹æƒ³å®šï¼ˆä»Šå›ã¯ç°¡æ˜“çš„ã«ï¼‰
                    console.log("Firebase object already defined on DOMContentLoaded, simulating firebase-initialized.");
                    const event = new Event('firebase-initialized');
                    document.dispatchEvent(event);
                 }
            } else {
                console.log("Firebase object/services not ready yet on DOMContentLoaded, waiting for firebase-initialized event...");
            }

        });
    </script>
</body>
</html>
